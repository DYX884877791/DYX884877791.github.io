<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring AOP设计原理详解 | 吃饭睡觉打豆豆</title>
    <meta name="description" content=" ">
    <link rel="icon" href="/favicon.png">
  <link rel="manifest" href="/images/pic.jpg">
  <link rel="apple-touch-icon" href="/images/pic.jpg">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.0f5aefa9.css" as="style"><link rel="preload" href="/assets/js/app.2ed4a716.js" as="script"><link rel="preload" href="/assets/js/2.0d3085da.js" as="script"><link rel="preload" href="/assets/js/46.a4cc6906.js" as="script"><link rel="prefetch" href="/assets/js/10.56332b24.js"><link rel="prefetch" href="/assets/js/11.dc70378b.js"><link rel="prefetch" href="/assets/js/12.c27a5cc7.js"><link rel="prefetch" href="/assets/js/13.cd445f8c.js"><link rel="prefetch" href="/assets/js/14.a519b732.js"><link rel="prefetch" href="/assets/js/15.71d77324.js"><link rel="prefetch" href="/assets/js/16.2282c2e6.js"><link rel="prefetch" href="/assets/js/17.84ef61f7.js"><link rel="prefetch" href="/assets/js/18.f341b90a.js"><link rel="prefetch" href="/assets/js/19.28081019.js"><link rel="prefetch" href="/assets/js/20.400cb076.js"><link rel="prefetch" href="/assets/js/21.54d5f8e0.js"><link rel="prefetch" href="/assets/js/22.302d416f.js"><link rel="prefetch" href="/assets/js/23.bcb3ed03.js"><link rel="prefetch" href="/assets/js/24.7b575690.js"><link rel="prefetch" href="/assets/js/25.eef0e9ab.js"><link rel="prefetch" href="/assets/js/26.e5319516.js"><link rel="prefetch" href="/assets/js/27.7a39b9af.js"><link rel="prefetch" href="/assets/js/28.53ab4bfa.js"><link rel="prefetch" href="/assets/js/29.6da66f35.js"><link rel="prefetch" href="/assets/js/3.579889d3.js"><link rel="prefetch" href="/assets/js/30.7ce82f78.js"><link rel="prefetch" href="/assets/js/31.4f595fb1.js"><link rel="prefetch" href="/assets/js/32.4ea77839.js"><link rel="prefetch" href="/assets/js/33.7fa19738.js"><link rel="prefetch" href="/assets/js/34.ca110b46.js"><link rel="prefetch" href="/assets/js/35.af16c3a0.js"><link rel="prefetch" href="/assets/js/36.146105e1.js"><link rel="prefetch" href="/assets/js/37.a725ceea.js"><link rel="prefetch" href="/assets/js/38.cadf49e9.js"><link rel="prefetch" href="/assets/js/39.537fbddf.js"><link rel="prefetch" href="/assets/js/4.6eb19324.js"><link rel="prefetch" href="/assets/js/40.e9f8e128.js"><link rel="prefetch" href="/assets/js/41.19f8fb66.js"><link rel="prefetch" href="/assets/js/42.0a39bbea.js"><link rel="prefetch" href="/assets/js/43.0ed9d746.js"><link rel="prefetch" href="/assets/js/44.89f92846.js"><link rel="prefetch" href="/assets/js/45.2e313083.js"><link rel="prefetch" href="/assets/js/47.7061b060.js"><link rel="prefetch" href="/assets/js/48.d40e2261.js"><link rel="prefetch" href="/assets/js/49.07b001ce.js"><link rel="prefetch" href="/assets/js/5.b5ba2def.js"><link rel="prefetch" href="/assets/js/50.5b6f7890.js"><link rel="prefetch" href="/assets/js/51.23496ee3.js"><link rel="prefetch" href="/assets/js/52.687b8402.js"><link rel="prefetch" href="/assets/js/53.c79069f6.js"><link rel="prefetch" href="/assets/js/54.69c422ad.js"><link rel="prefetch" href="/assets/js/55.0b2eddb9.js"><link rel="prefetch" href="/assets/js/56.a908f57d.js"><link rel="prefetch" href="/assets/js/57.c1b2dbbd.js"><link rel="prefetch" href="/assets/js/58.07a79fec.js"><link rel="prefetch" href="/assets/js/59.0e076c5f.js"><link rel="prefetch" href="/assets/js/6.6725e2bb.js"><link rel="prefetch" href="/assets/js/60.45e33df3.js"><link rel="prefetch" href="/assets/js/61.8aca7760.js"><link rel="prefetch" href="/assets/js/62.302ed63d.js"><link rel="prefetch" href="/assets/js/63.097511c4.js"><link rel="prefetch" href="/assets/js/64.a9c1111f.js"><link rel="prefetch" href="/assets/js/65.5c7e6580.js"><link rel="prefetch" href="/assets/js/66.4d31114d.js"><link rel="prefetch" href="/assets/js/67.a9492502.js"><link rel="prefetch" href="/assets/js/68.0faaaa93.js"><link rel="prefetch" href="/assets/js/69.bfbae9d0.js"><link rel="prefetch" href="/assets/js/7.5d32872a.js"><link rel="prefetch" href="/assets/js/8.63ab5f4b.js"><link rel="prefetch" href="/assets/js/9.a0ac733d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0f5aefa9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">吃饭睡觉打豆豆</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">BackEnd</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/后端/Java/JavaSE/变量.html" class="nav-link">JavaSE</a></li><li class="dropdown-subitem"><a href="/后端/Java/JavaEE/" class="nav-link">JavaEE</a></li></ul></li><li class="dropdown-item"><!----> <a href="/后端/Redis/Redis从入门到高可用分布式实践/目录说明.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/后端/Kafka/Kafka原理介绍.html" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/后端/Python/" class="nav-link">Python</a></li><li class="dropdown-item"><h4>Spring</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/后端/Spring源码解析/Spring源码解析.html" class="nav-link">Spring源码解析</a></li></ul></li><li class="dropdown-item"><h4>Linux</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/linux/" class="nav-link">Linux</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">FrontEnd</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">Frontend</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/数据结构与算法/数据结构不难/" class="nav-link">数据结构不难</a></li><li class="dropdown-item"><!----> <a href="/数据结构与算法/算法很美/" class="nav-link">算法很美</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/大数据/Hadoop/README.html" class="nav-link">Hadoop</a></li></ul></div></div> <a href="https://github.com/DYX884877791/DYX884877791.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">BackEnd</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/后端/Java/JavaSE/变量.html" class="nav-link">JavaSE</a></li><li class="dropdown-subitem"><a href="/后端/Java/JavaEE/" class="nav-link">JavaEE</a></li></ul></li><li class="dropdown-item"><!----> <a href="/后端/Redis/Redis从入门到高可用分布式实践/目录说明.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/后端/Kafka/Kafka原理介绍.html" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/后端/Python/" class="nav-link">Python</a></li><li class="dropdown-item"><h4>Spring</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/后端/Spring源码解析/Spring源码解析.html" class="nav-link">Spring源码解析</a></li></ul></li><li class="dropdown-item"><h4>Linux</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/linux/" class="nav-link">Linux</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">FrontEnd</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">Frontend</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/数据结构与算法/数据结构不难/" class="nav-link">数据结构不难</a></li><li class="dropdown-item"><!----> <a href="/数据结构与算法/算法很美/" class="nav-link">算法很美</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/大数据/Hadoop/README.html" class="nav-link">Hadoop</a></li></ul></div></div> <a href="https://github.com/DYX884877791/DYX884877791.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">首页</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring源码解析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/后端/Spring源码解析/Spring源码解析.html" class="sidebar-link">Spring源码解析</a></li><li><a href="/后端/Spring源码解析/IoC容器的实现.html" class="sidebar-link">Spring IoC容器的实现</a></li><li><a href="/后端/Spring源码解析/AOP设计原理详解.html" class="active sidebar-link">Spring AOP设计原理详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/后端/Spring源码解析/AOP设计原理详解.html#aspect-oriented-programming：面向切面编程" class="sidebar-link">Aspect Oriented Programming：面向切面编程</a></li><li class="sidebar-sub-header"><a href="/后端/Spring源码解析/AOP设计原理详解.html#spring-aop目标" class="sidebar-link">Spring AOP目标</a></li><li class="sidebar-sub-header"><a href="/后端/Spring源码解析/AOP设计原理详解.html#aop-vs-继承" class="sidebar-link">AOP vs 继承</a></li><li class="sidebar-sub-header"><a href="/后端/Spring源码解析/AOP设计原理详解.html#aop核心概念" class="sidebar-link">AOP核心概念</a></li><li class="sidebar-sub-header"><a href="/后端/Spring源码解析/AOP设计原理详解.html#spring-aop实现" class="sidebar-link">Spring AOP实现</a></li><li class="sidebar-sub-header"><a href="/后端/Spring源码解析/AOP设计原理详解.html#目标代理对象的创建" class="sidebar-link">目标代理对象的创建</a></li><li class="sidebar-sub-header"><a href="/后端/Spring源码解析/AOP设计原理详解.html#代理模式" class="sidebar-link">代理模式</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>动态代理</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-aop设计原理详解"><a href="#spring-aop设计原理详解" aria-hidden="true" class="header-anchor">#</a> Spring AOP设计原理详解</h1> <h2 id="aspect-oriented-programming：面向切面编程"><a href="#aspect-oriented-programming：面向切面编程" aria-hidden="true" class="header-anchor">#</a> Aspect Oriented Programming：面向切面编程</h2> <h2 id="spring-aop目标"><a href="#spring-aop目标" aria-hidden="true" class="header-anchor">#</a> Spring AOP目标</h2> <ol><li>将分散在程序各处的横切关注点剥离出来并以集中的方式进行表达</li> <li>使得开发人员能够专注于业务逻辑的实现而非繁杂的非功能代码，简化了程序编写与单元测试</li> <li>应用场景：日志、安全、事务</li></ol> <h2 id="aop-vs-继承"><a href="#aop-vs-继承" aria-hidden="true" class="header-anchor">#</a> AOP vs 继承</h2> <ol><li>AOP重点考虑的是程序的横切逻辑</li> <li>继承重点考虑的是纵向的职责分派</li></ol> <h2 id="aop核心概念"><a href="#aop核心概念" aria-hidden="true" class="header-anchor">#</a> AOP核心概念</h2> <ol><li>Advice：通知：定义在连接点处的行为，围绕方法调用而进行注入———（确定要切入的方法是什么）</li> <li>Pointcut：切点：确定在哪些连接点处应用通知———（确定在哪些地方应用要切入的方法）</li> <li>Advisor：通知器：组合Advice和Pointcut</li></ol> <h2 id="spring-aop实现"><a href="#spring-aop实现" aria-hidden="true" class="header-anchor">#</a> Spring AOP实现</h2> <ol><li><p>ProxyFactoryBean</p> <ol><li>A FactoryBean implemention that builds an AOP proxy based on beans in Spring BeanFactory</li> <li>Spring AOP的底层实现与源头</li></ol></li> <li><p>ProxyFactoryBean的典型配置</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myAOP<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.springframework.aop.framework.ProxyFactoryBean<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>proxyInterfaces<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>com.test.myInterface<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>interceptorNames<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>	
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>myAdvisor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>target<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ref</span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myTarget<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ref</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myTarget<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.test.myTarget<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myAdvisor<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.test.MyAdvisor<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>当从myAOP这个“ProxyFactoryBean”中获取对象时，取得的是ProxyFactoryBean所构造的一个实例，该实例是myTarget类的一个代理对象，且该实例应用了MyAdvisor通知器（通知器可以有多个），同时该代理对象还实现了myInterface接口</p></li> <li><p>ProxyFactoryBean的构成</p> <ol><li>target：目标对象，需要对其进行切面增强</li> <li>proxyInterfaces：代理对象所实现的接口</li> <li>interceptorNames：通知器（Advisor）列表，通知器中包含了通知（Advice）和切点（Pointcut）</li></ol></li> <li><p>ProxyFactoryBean的作用
总的来说，ProxyFactoryBean的作用可以用下面这句话概括：针对目标对象来创建代理对象，将对目标对象方法的调用转到对相应代理对象方法的调用，并且可以在调用代理对象方法前后执行与之匹配的各个通知器中定义好的方法</p></li></ol> <h2 id="目标代理对象的创建"><a href="#目标代理对象的创建" aria-hidden="true" class="header-anchor">#</a> 目标代理对象的创建</h2> <ol><li><p>Spring通过两种方式来创建目标代理对象</p> <ol><li>JDK动态代理</li> <li>cglib</li></ol></li> <li><p>JDK动态代理：如果目标对象实现了接口，那么Spring就会通过JDK动态代理为目标对象生成代理对象，这也是JDK的要求，要求目标对象必须实现某一个接口，否则实现不了JDK动态代理</p></li> <li><p>创建动态代理：其中AopProxy是代理的接口，Spring中有两个实现类：JdkDynamicAopProxy（JDK动态代理）和CglibAopProxy（cglib动态代理）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AopProxy</span> <span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AopConfigException</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasNoUserSuppliedProxyInterfaces</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Class</span> targetClass <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopConfigException</span><span class="token punctuation">(</span><span class="token string">&quot;TargetSource cannot determine target class: &quot;</span> <span class="token operator">+</span>
						<span class="token string">&quot;Either an interface or a target is required for proxy creation.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token class-name">CglibProxyFactory</span><span class="token punctuation">.</span><span class="token function">createCglibProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

</code></pre></div></li></ol> <h2 id="代理模式"><a href="#代理模式" aria-hidden="true" class="header-anchor">#</a> 代理模式</h2> <ol><li><p>代理模式的作用是：为其他对象提供一种代理以控制对这个对象的访问</p></li> <li><p>在某些情况下，一个客户不想或者不能直接引用另一个对象，而代理对象可以在客户端和目标对象之间起到中介的作用</p></li> <li><p>代理模式一般涉及到的角色有：</p> <ol><li><p>抽象角色：声明真实角色和代理角色对象的共同接口</p></li> <li><p>代理角色：代理对象角色内部含有真实角色的引用，从而可以操作真实对象，同时代理对象提供与真色角色相同的接口以便在任何时刻都能代替真实对象；同时代理对象可以在执行真实对象操作时，附加其他的操作，相当于对真实对象进行封装</p></li> <li><p>真实角色：代理对象所代表的真实对象，是我们最终要引用的对象</p></li> <li><p>代码示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 公共接口</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>
   <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 真实角色</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RealSubject</span> <span class="token keyword">implements</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;做些什么呢?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 代理角色</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxySubject</span> <span class="token keyword">implements</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token class-name">RealSubject</span> realSubject<span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token class-name">ProxySubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>realSubject <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         realSubject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;befor do something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      realSubject<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;after do something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 客户端访问</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxySubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      subject<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>由以上代码可以看出，客户实际上需要调用的是真实角色RealSubject的方法，现在用ProxySubject来代理RealSubject类，同样达到目的，同时还可以封装其他方法，可以处理其他问题</p></li> <li><p>另外，如果按照上述的方法使用代理模式，那么真实角色必须是事先已经存在的，并将其作为代理对象的内部属性。但是实际使用时，一个真实角色必须对应一个代理角色，如果大量使用会导致类的急剧膨胀；此外，如果事先并不知道真实角色，该如何使用代理呢？此时可以使用<strong>动态代理</strong>来解决！</p></li></ol></li> <li><p>动态代理：Spring中动态代理实现有两种方式：JDK动态代理和cglib动态代理</p> <ol><li><p>Java动态代理位于java.lang.Reflect包下，一般主要涉及到以下两个类（接口）：</p> <ol><li><p>Interface InvocationHandler：该接口中仅定义了一个方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> object <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在实际使用时，第一个参数obj一般指代理类，method一般指被代理的方法，args为该方法的参数数组，如果没参数则为null，这个抽象方法在代理类中动态实现。</p></li> <li><p>Proxy：该类即为动态代理类，其中主要包含以下内容：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span><span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span>
</code></pre></div><p>返回代理类的一个实例，返回后的代理类可以被当做被代理类使用</p></li></ol></li> <li><p>动态代理是这样一种class：在运行时生成class（代理类），在生成它时必须提供一组interface给它，然后该class就会声明它实现了这些interface，因此可以将该class的实例当做这些interface中的任何一个来使用。实际上，这个class类就是一个Proxy类，它不会替你做实质性的工作，在生成它的实例时必须提供一个handler，由handler接管实际的工作。（在Java里面有这样一个限定：<strong>要想创建某一个对象的代理对象，那么该对象必须实现一个接口</strong>，每一个动态代理类都必须要实现InvocationHandler这个接口，并且每个代理类的实例都关联到了一个handler，当我们通过代理对象调用一个方法的时候，将对方法调用进行编码并将其指派到它的调用处理程序InvocationHandler的 invoke 方法。所以对代理方法的调用都是通<code>InvocationHadler</code>的invoke来实现中，而invoke方法根据传入的代理对象，方法和参数来决定调用代理的哪个方法。）</p></li> <li><p>JDK动态代理代码示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 公共接口</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>
   <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 真实角色</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RealSubject</span> <span class="token keyword">implements</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;做些什么呢?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 动态代理角色</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicProxySubject</span> implement <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>
      <span class="token keyword">private</span> <span class="token class-name">Object</span> target<span class="token punctuation">;</span>
         <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
         <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
         <span class="token comment">// 前置处理</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;befor do something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ...核心，实际上是真实角色在调用</span>
         <span class="token comment">// 后置处理</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;after do something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 客户端访问</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 1. 来一个真实角色：</span>
         <span class="token class-name">Subject</span> realSubject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 2. 代理类，(相当于一个生成代理实例的工厂)，且生成的代理类类名以&quot;$Proxy&quot;开头</span>
         <span class="token class-name">DynamicProxySubject</span> dynamicProxySubject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicProxySubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 3. 生成代理实例</span>
         <span class="token class-name">Subject</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Subject</span><span class="token punctuation">)</span> dynamicProxySubject<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>realSubject<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 4. 调用方法，实际上会转发到invoke(...)中调用</span>
         proxy<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>大概流程：</p> <ol><li>为接口创建代理类的字节码文件:</li> <li>使用ClassLoader将字节码文件加载到JVM</li> <li>创建代理类实例对象，执行对象的目标方法</li></ol></li></ol></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/后端/Spring源码解析/IoC容器的实现.html" class="prev">Spring IoC容器的实现</a></span> <span class="next"><a href="/后端/Spring源码解析/动态代理.html">代理模式的理解</a>→
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.2ed4a716.js" defer></script><script src="/assets/js/2.0d3085da.js" defer></script><script src="/assets/js/46.a4cc6906.js" defer></script>
  </body>
</html>
